# Monitoring & Observability Setup Guide

This guide covers the complete monitoring and observability setup for the API Builder platform.

## Overview

The monitoring system includes:

1. **Sentry** - Error tracking and performance monitoring
2. **Structured Logging** - JSON-formatted logs with correlation IDs
3. **System Metrics** - CPU, memory, uptime, request tracking
4. **Health Checks** - Endpoint health and database connectivity
5. **Real-time Dashboard** - React-based monitoring UI with live metrics

## Quick Start (5 Minutes)

### 1. Sign Up for Sentry (Free)

1. Go to [sentry.io](https://sentry.io/signup/)
2. Create a free account
3. Create a new project:
   - Choose "Python" for backend
   - Choose "React" for frontend
4. Copy the DSN (looks like: `https://xxxxx@sentry.io/xxxxx`)

### 2. Configure Backend

Add to `fastapi-backend/.env`:

```bash
SENTRY_DSN=your_backend_sentry_dsn_here
ENVIRONMENT=production
```

### 3. Configure Frontend

Add to root `.env`:

```bash
VITE_SENTRY_DSN=your_frontend_sentry_dsn_here
```

### 4. Install Dependencies

```bash
# Backend
cd fastapi-backend
pip install -r requirements.txt

# Frontend
cd ..
npm install
```

### 5. Restart Services

```bash
# Backend
docker-compose restart fastapi-gateway

# Frontend
npm run dev
```

**That's it!** Your monitoring is now active.

## Features

### 1. Error Tracking with Sentry

**Backend:**
- Automatic exception capture
- Stack traces with full context
- Performance monitoring (10% of requests)
- Request breadcrumbs

**Frontend:**
- JavaScript error tracking
- User session replay (errors only)
- Performance monitoring
- React component stack traces

### 2. Structured Logging

All logs are JSON-formatted with:
- Timestamp (UTC)
- Log level (INFO, WARNING, ERROR)
- Request ID (correlation across services)
- Contextual data (API ID, user ID, etc.)

Example log entry:
```json
{
  "timestamp": "2025-10-25T12:34:56.789Z",
  "level": "INFO",
  "service": "api-gateway",
  "message": "Request processed",
  "request_id": "a1b2c3d4-e5f6-7890",
  "method": "GET",
  "path": "/api-id",
  "status_code": 200,
  "process_time_ms": 45.67
}
```

### 3. System Metrics

Access via `/metrics` endpoint (admin only):

```bash
curl -H "Authorization: Bearer YOUR_ADMIN_KEY" \
  https://your-gateway.com/metrics
```

Returns:
- Uptime (seconds and formatted)
- Total requests processed
- Total errors
- Error rate (percentage)
- Average response time (ms)
- Memory usage (MB)
- CPU usage (percentage)
- Timestamp

### 4. Health Checks

**Basic Health Check** - `/health`
```bash
curl https://your-gateway.com/health
```

Returns:
```json
{
  "status": "healthy",
  "loaded_apis": 5,
  "database": "connected",
  "sentry_enabled": true,
  "timestamp": "2025-10-25T12:34:56.789Z"
}
```

**Root Endpoint** - `/`
```bash
curl https://your-gateway.com/
```

Returns:
```json
{
  "service": "API Builder Gateway",
  "status": "running",
  "loaded_apis": 5,
  "timestamp": "2025-10-25T12:34:56.789Z"
}
```

### 5. Monitoring Dashboard

Access at `/monitoring` in your web app.

**Features:**
- Real-time system metrics (auto-refresh every 30s)
- Gateway status indicator
- Resource usage (CPU, memory)
- Request statistics (24h and 1h windows)
- Top 5 most-used APIs
- Error tracking
- Database connectivity status

**Metrics Displayed:**
- Uptime
- Total requests
- Average response time
- Error rate
- Memory usage
- CPU usage
- Loaded APIs count
- Database status
- Requests per hour/day
- Top APIs by usage

## Request Correlation

Every request gets a unique ID that flows through:
1. Frontend request
2. Backend processing
3. Logs
4. Error reports in Sentry

The ID is:
- Generated by the backend middleware
- Added to response headers as `X-Request-ID`
- Included in all log entries
- Attached to Sentry events

**Usage:**
When debugging an issue, search logs by request ID to see the complete flow.

## Monitoring Best Practices

### 1. Set Up Uptime Monitoring

Use a free service like:
- [UptimeRobot](https://uptimerobot.com/) (recommended)
- [Better Uptime](https://betteruptime.com/)
- [StatusCake](https://www.statuscake.com/)

**What to monitor:**
- `https://your-gateway.com/health` - Main health check
- `https://your-app.com` - Frontend availability

**Alert channels:**
- Email
- Slack
- SMS (for critical services)

### 2. Configure Sentry Alerts

In your Sentry dashboard:
1. Go to Alerts
2. Create new alert rules:
   - Error rate > 5% for 5 minutes
   - New error type introduced
   - Performance degradation (p95 > 2s)

### 3. Review Metrics Daily

Check the monitoring dashboard daily for:
- Unusual error rate spikes
- Memory/CPU trends
- Slow response times
- API usage patterns

### 4. Log Retention

**Development:**
- Console logs (ephemeral)
- Sentry keeps 30 days on free tier

**Production:**
Consider adding:
- Cloud logging (AWS CloudWatch, Google Cloud Logging)
- Log aggregation (ELK Stack, Loki)
- Long-term storage for compliance

## Troubleshooting

### Sentry Not Working

**Check:**
1. DSN is correctly set in `.env`
2. Services have been restarted
3. No network/firewall blocking sentry.io
4. Check logs for Sentry initialization message

**Test manually:**
```python
# In Python
import sentry_sdk
sentry_sdk.capture_message("Test message")
```

```javascript
// In JavaScript
import * as Sentry from "@sentry/react";
Sentry.captureMessage("Test message");
```

### Metrics Endpoint Returns 401

**Issue:** Admin API key not configured or incorrect

**Fix:**
1. Check `ADMIN_API_KEY` in backend `.env`
2. Ensure `VITE_ADMIN_API_KEY` matches in frontend `.env`
3. Include header: `Authorization: Bearer YOUR_KEY`

### Dashboard Shows No Data

**Check:**
1. Backend is running and accessible
2. Supabase connection is working
3. `api_usage` table has data
4. Browser console for errors
5. CORS is properly configured

### High Memory Usage

**Normal range:** 200-500 MB for light traffic

**If higher:**
1. Check number of loaded APIs (`/metrics` → loaded_apis)
2. Review API code for memory leaks
3. Consider restarting gateway periodically
4. Implement API unloading for inactive APIs

## Production Checklist

- [ ] Sentry configured for both frontend and backend
- [ ] Uptime monitoring service configured
- [ ] Alert channels configured (email/Slack)
- [ ] Admin API key is secure and not exposed
- [ ] CORS properly configured
- [ ] Health check endpoints accessible
- [ ] Monitoring dashboard restricted to admins
- [ ] Log retention policy defined
- [ ] Backup and disaster recovery plan
- [ ] Performance baselines established
- [ ] On-call rotation defined (if applicable)

## Metrics to Track Over Time

**Performance:**
- Average response time (target: < 200ms)
- P95 response time (target: < 500ms)
- P99 response time (target: < 1s)

**Reliability:**
- Error rate (target: < 1%)
- Uptime (target: 99.9%)
- Failed deployments (target: 0%)

**Usage:**
- Requests per day (growth indicator)
- Active APIs (growth indicator)
- Unique users per day

**Resources:**
- CPU usage (target: < 70%)
- Memory usage (target: < 80%)
- Database connections (monitor for leaks)

## Advanced: Custom Metrics

To add custom business metrics, extend the `MetricsCollector` class in `monitoring.py`:

```python
class MetricsCollector:
    def __init__(self):
        # ... existing code ...
        self.custom_counter = 0

    def increment_custom(self):
        self.custom_counter += 1

    def get_metrics(self):
        metrics = {
            # ... existing metrics ...
            "custom_metric": self.custom_counter
        }
        return metrics
```

## Cost Considerations

**Free Tier Limits:**

**Sentry:**
- 5,000 errors/month
- 10,000 performance units/month
- 30 days retention
- Unlimited team members

**Sufficient for:**
- Small to medium apps
- Up to ~50k requests/month
- Development and staging environments

**When to upgrade:**
- Production app with > 100k requests/month
- Need longer retention (90 days+)
- Advanced features (custom dashboards, teams)

## Support

**Issues:**
- Check logs first (structured JSON logs)
- Search by request ID for specific issues
- Review Sentry for error patterns

**Questions:**
- Review this guide
- Check Sentry documentation
- Contact support team

## Summary

This monitoring setup provides:
- ✅ Real-time error tracking
- ✅ Performance monitoring
- ✅ System health visibility
- ✅ Request tracing
- ✅ Production-ready observability

**Time to set up:** 5-10 minutes
**Cost:** Free (with Sentry free tier)
**Value:** Priceless for debugging and reliability
